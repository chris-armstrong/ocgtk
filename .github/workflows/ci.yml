name: CI

on:
  push:
    branches: [ main, lablgtk4, claude/* ]
  pull_request:
    branches: [ main, lablgtk4 ]
  workflow_dispatch:

# CI Notes:
# - Repository now contains both lablgtk3/ (GTK 3) and lablgtk4/ (GTK 4)
# - lablgtk3: depext for goocanvas2 is broken on windows and osx
# - lablgtk3: depext for gtkspell is broken on windows
# - lablgtk4: GTK 4 support is under development, failures expected

jobs:
  build-lablgtk3:
    name: Build LablGTK3 (GTK 3)
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        ocaml-compiler: [4.09.x, 4.10.x, 4.11.x, 4.12.x, 4.13.x, 4.14.x, 5.1.x]
        test-packages: [lablgtk3 lablgtk3-sourceview3 lablgtk3-gtkspell3 lablgtk3-goocanvas2]
        test-target: [opam, dev-all]
        include:
        - os: ubuntu-latest
          ocaml-compiler: 4.14.x
          test-packages: lablgtk3 lablgtk3-sourceview3 lablgtk3-gtkspell3 lablgtk3-goocanvas2
          test-target: dev
        - os: macos-latest
          ocaml-compiler: 4.14.x
          test-packages: lablgtk3 lablgtk3-sourceview3 lablgtk3-gtkspell3
          test-target: dev-ci-osx
        - os: windows-latest
          ocaml-compiler: 4.14.x
          test-packages: lablgtk3 lablgtk3-sourceview3
          test-target: dev-ci-windows

    env:
      OPAMJOBS: "2"
      OPAMROOTISOK: "true"
      OPAMYES: "true"
      NJOBS: "2"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up OCaml ${{ matrix.ocaml-compiler }}
        uses: ocaml/setup-ocaml@v2
        with:
          ocaml-compiler: ${{ matrix.ocaml-compiler }}
          dune-cache: true
          opam-depext: true

      - name: Install deps
        working-directory: lablgtk3
        run: opam install ${{ matrix.test-packages }} --deps-only --with-test

      - name: Display OPAM Setup
        run: opam exec -- opam list

      - name: Test LablGTK3
        working-directory: lablgtk3
        run: opam exec -- make ${{ matrix.test-target }}

  build-lablgtk4:
    name: Build LablGTK4 (GTK 4)
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        ocaml-compiler: [4.14.x, 5.1.x]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up OCaml
        uses: ocaml/setup-ocaml@v2
        with:
          ocaml-compiler: ${{ matrix.ocaml-compiler }}
          dune-cache: true

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-4-dev \
            libcairo2-dev \
            libpango1.0-dev \
            libgdk-pixbuf-2.0-dev

      - name: Install OCaml dependencies
        working-directory: lablgtk4
        run: opam install cairo2 dune
        continue-on-error: true

      - name: Build lablgtk4
        working-directory: lablgtk4
        run: opam exec -- dune build
        continue-on-error: true

      - name: Run lablgtk4 tests
        working-directory: lablgtk4
        run: opam exec -- dune runtest
        continue-on-error: true
